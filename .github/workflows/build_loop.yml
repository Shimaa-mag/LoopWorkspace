name: Build Loop

on:
  workflow_dispatch:

jobs:
  build:
    runs-on: macos-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Select latest Xcode
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: latest

      - name: Import signing certificate
        uses: apple-actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.APPLE_P12 }}
          p12-password:   ${{ secrets.P12_PASSWORD }}

      - name: Install provisioning profiles
        uses: apple-actions/download-provisioning-profiles@v1
        with:
          profile-base64: |
            ${{ secrets.PROVISIONING_PROFILE }}
            ${{ secrets.PP_WATCHAPP }}
            ${{ secrets.PP_WATCHEXT }}

      - name: Debug codesigning
        run: |
          security find-identity -v -p codesigning || true
          ls -l ~/Library/MobileDevice/Provisioning\ Profiles || true

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          bundler-cache: true

      - name: Install gems
        run: bundle install

      - name: Build with fastlane lane
        continue-on-error: true
        run: bundle exec fastlane ios build_loop

      - name: Build with gym (fallback)
        if: failure()
        run: |
          bundle exec fastlane run gym \
            scheme:"LoopWorkspace" \
            configuration:"Release" \
            export_method:"app-store" \
            output_directory:"build" \
            skip_package_ipa:false

      - name: Upload IPA
        uses: actions/upload-artifact@v4
        with:
          name: Loop-IPA
          path: |
            build/*.ipa
            **/*.ipa
